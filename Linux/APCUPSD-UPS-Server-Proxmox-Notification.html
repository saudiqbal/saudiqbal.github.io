<!DOCTYPE html>
<html lang="en">
<head>
<title>APCUPSD UPS server for Proxmox, notifications</title>
<meta name="keywords" content="APCUPSD, UPS, Server, Proxmox, Notifications">
<meta name="description" content="APCUPSD UPS server for Proxmox, notifications">
<meta name="viewport" content="user-scalable=yes, initial-scale=1, width=device-width">
<link rel="stylesheet" type="text/css" href="/css/styles.css">
<link rel="stylesheet" type="text/css" href="/css/codeblock.css">
</head>
<body>
<div class="header">
<span class="headerlogo">saudiqbal.github.io</span>
<input class="menu-btn" type="checkbox" id="menu-btn" />
<label class="menu-icon" for="menu-btn"><span class="navicon"></span></label>
<ul class="menu">
<li><a href="/">Home</a></li>
<li><a href="https://www.saudiqbal.com/contact-me.php">Send Feedback</a></li>
</ul>
</div>
<div class="content">
<h1 class="titletextshadow">APCUPSD UPS server for Proxmox, notifications</h1>
<article>
<p>Are you looking to setup your own UPS server for notifications and monitoring or shutdown / starting other servers then this simple tutorial is for you.</p>
<p style="font-weight: bold;">Installation of required softwares</p>
<p>Nginx web server <span class="code-group"><span class="code-group-prepend"><span class="code-group-text" id="nginx">apt install nginx</span></span><span onclick="copyToClipboard('nginx')" class="form-control copy-tooltip"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linejoin="round" stroke-width="2" d="M14 4v3a1 1 0 0 1-1 1h-3m4 10v1a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1V9a1 1 0 0 1 1-1h2m11-3v10a1 1 0 0 1-1 1h-7a1 1 0 0 1-1-1V7.87a1 1 0 0 1 .24-.65l2.46-2.87a1 1 0 0 1 .76-.35H18a1 1 0 0 1 1 1Z"/></svg><span class="copy-tooltiptext">Copy Text</span></span></span></p>
<p>PHP <span class="code-group"><span class="code-group-prepend"><span class="code-group-text" id="php-fpm">apt install php-fpm php-sqlite3</span></span><span onclick="copyToClipboard('php-fpm')" class="form-control copy-tooltip"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linejoin="round" stroke-width="2" d="M14 4v3a1 1 0 0 1-1 1h-3m4 10v1a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1V9a1 1 0 0 1 1-1h2m11-3v10a1 1 0 0 1-1 1h-7a1 1 0 0 1-1-1V7.87a1 1 0 0 1 .24-.65l2.46-2.87a1 1 0 0 1 .76-.35H18a1 1 0 0 1 1 1Z"/></svg><span class="copy-tooltiptext">Copy Text</span></span></span></p>
<p>Wakeonlan <span class="code-group"><span class="code-group-prepend"><span class="code-group-text" id="wakeonlan">apt install wakeonlan</span></span><span onclick="copyToClipboard('wakeonlan')" class="form-control copy-tooltip"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linejoin="round" stroke-width="2" d="M14 4v3a1 1 0 0 1-1 1h-3m4 10v1a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1V9a1 1 0 0 1 1-1h2m11-3v10a1 1 0 0 1-1 1h-7a1 1 0 0 1-1-1V7.87a1 1 0 0 1 .24-.65l2.46-2.87a1 1 0 0 1 .76-.35H18a1 1 0 0 1 1 1Z"/></svg><span class="copy-tooltiptext">Copy Text</span></span></span></p>
<p>APCUPSD <span class="code-group"><span class="code-group-prepend"><span class="code-group-text" id="apcupsd">apt install apcupsd</span></span><span onclick="copyToClipboard('apcupsd')" class="form-control copy-tooltip"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linejoin="round" stroke-width="2" d="M14 4v3a1 1 0 0 1-1 1h-3m4 10v1a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1V9a1 1 0 0 1 1-1h2m11-3v10a1 1 0 0 1-1 1h-7a1 1 0 0 1-1-1V7.87a1 1 0 0 1 .24-.65l2.46-2.87a1 1 0 0 1 .76-.35H18a1 1 0 0 1 1 1Z"/></svg><span class="copy-tooltiptext">Copy Text</span></span></span></p>
<p style="font-weight: bold;">Customization of files</p>
<p>Extract and upload all the files from the zip file in their appropriate directories and chmod all the bash (.sh) files to 755. Where ever you see <span class="code-group"><span class="code-group-plain"># Your additional notification API goes here</span></span> replace that line with your own call for other notifications like sending an email, just add your desired text message. Uncomment all curl entries for log entries to your notification server.</p>
<p>Replace <span class="code-group"><span class="code-group-plain">rpi.example.com</span></span> to the hostname or IP address of your UPS server</p>
<p>Replace <span class="code-group"><span class="code-group-plain">proxmox.example.com</span></span> to the hostname or IP address of your proxmox server, if you have one</p>
<p>Replace <span class="code-group"><span class="code-group-plain">D1:AE:52:C9:D3:C2</span></span> to the MAC address of your server for Wake On LAN</p>
<p>Adding a new Proxmox user to shutdown the server: Go to Datacenter > Groups > Create > Shutdown. Then go to Users > Add > Username: shutdown, Realm: Proxmox VE authentication server, add other details, Group > shutdown. Go to Roles > Create > Name: shutdown > Privileges Sys.PowerMgmt. Now go to Permissions link > Add > Path /, Group Shutdown, Role Shutdown then Add. Go to API Tokens > Add > User Shutdown > Privilige Separation = Uncheck, Copy token ID and Secret. Now edit the file <span class="code-group"><span class="code-group-plain">/root/onbattery-proxmox.sh</span></span> and change the token values on line 13 and change the node name in the url <span class="code-group"><span class="code-group-plain">https://proxmox.example.com:8006/api2/json/nodes/&lt;yournodenamehere&gt;/status</span></span></p>
<p>The disk size in the the bottom of UPS status might not work when you first upload the index.php file and view it in your web browser, to fix this edit the file <span class="code-group"><span class="code-group-plain">/var/www/html/index.php</span></span> and edit three lines and replace the root disk with the name of your disk, the name of my SD card is <span class="code-group"><span class="code-group-plain">/dev/mmcblk0p2</span></span>, you can get yours by running the command <span class="code-group"><span class="code-group-plain">df</span></span> for your UPS server.</p>
<p>To change the delay of shutting down the Proxmox or other servers change the sleep value of "sleep 60" in <span class="code-group"><span class="code-group-plain">/root/onbattery-proxmox.sh</span></span>, When the onbattery event is triggered the scripts wait for 60 seconds before shutting down the Proxmox server.
<p>Editing of bash script <span class="code-group"><span class="code-group-plain">/root/proxmox-up-check.sh</span></span> : <span class="code-group"><span class="code-group-plain">TARGET=proxmox.example.com</span></span> Hostname or IP address of Proxmox server, <span class="code-group"><span class="code-group-plain">sleep 15m</span></span> 15 minutes (to make sure the electricity is back for good) before sending the WOL packet (Change the MAC address D1:AE:52:C9:D3:C2 to your Proxmox server) to the Proxmox server and when the battery charge is at least 25% and UPS is online <span class="code-group"><span class="code-group-plain">[ "$batterystatus" -ge 25 ] && [ $upsstatus == "ONLINE" ]</span></span> then start the Proxmox server</p>
<p>Finally a Cron schedule to periodically check for Proxmox up or not (every hour), change it to what ever you want <span class="code-group"><span class="code-group-prepend"><span class="code-group-text" id="proxmoxupcheck">0 * * * * /bin/bash /root/proxmox-up-check.sh > /dev/null 2>&1</span></span><span onclick="copyToClipboard('proxmoxupcheck')" class="form-control copy-tooltip"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linejoin="round" stroke-width="2" d="M14 4v3a1 1 0 0 1-1 1h-3m4 10v1a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1V9a1 1 0 0 1 1-1h2m11-3v10a1 1 0 0 1-1 1h-7a1 1 0 0 1-1-1V7.87a1 1 0 0 1 .24-.65l2.46-2.87a1 1 0 0 1 .76-.35H18a1 1 0 0 1 1 1Z"/></svg><span class="copy-tooltiptext">Copy Text</span></span></span></p>
<p><a href="https://github.com/saudiqbal/saudiqbal.github.io/raw/refs/heads/main/files/APCUPSD-UPS.zip" class="download-button" download>Download</a></p>
<p><a href="https://github.com/saudiqbal/saudiqbal.github.io/discussions">Discussions link</a></p>
<p><h2>Screenshot</h2></p>
<p><img src="/images/apcupsd-ups.jpg" alt="" class="fluidimg"></p>
<p><span>Let me know if you have any comments or if there is any error in this guide.</span></p>
</article>
<div class="footer">
<div style="margin: 0 auto; padding:25px;">
<a href="https://github.com/saudiqbal" style="text-decoration: none;color: #000;">https://github.com/saudiqbal</a>
</div>
</div>
</div>
<script src="/js/codeblock.js"></script>
<script>
setTimeout(() => {
var protocol = 'https://';
var domain = 'saudiqbal.com';
var file = '/si-visitor.php?url=';
var url = window.location.href;
var and = "&referrer=";
var referrer = document.referrer;
var address = protocol+domain+file+url+and+referrer;
var xmlhttp;
if (window.XMLHttpRequest) {
xmlhttp=new XMLHttpRequest();
}
else {
xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
}
xmlhttp.open("GET",address,true);
xmlhttp.send();
}, 1000)
</script>
</body>
</html>